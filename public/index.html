import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  query, 
  setDoc, 
  doc,
  deleteDoc,
  updateDoc,
  getDocs,
  writeBatch
} from 'firebase/firestore';
import { 
  Heart, Gift, Copy, Check, ExternalLink, Loader2, QrCode, 
  Plus, Minus, Settings, Users, Package, Trash2, X, LogIn, Pencil, Phone, Mail, Fingerprint, Hash, AlertTriangle
} from 'lucide-react';

// Configuração do Firebase integrada no ambiente
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'wedding-gui-nuria';

// Palavra-passe de administrador
const ADMIN_PASSWORD = "123"; 

// --- UTILITÁRIOS PARA GERAÇÃO DE PIX ESTÁTICO (PADRÃO BRCODE / EMV) ---
// Estas funções garantem a compatibilidade com as aplicações bancárias
const crc16 = (data) => {
  let crc = 0xFFFF;
  for (let i = 0; i < data.length; i++) {
    crc ^= data.charCodeAt(i) << 8;
    for (let j = 0; j < 8; j++) {
      if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021;
      else crc <<= 1;
    }
  }
  return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
};

const formatTag = (id, value) => {
  const len = value.length.toString().padStart(2, '0');
  return `${id}${len}${value}`;
};

const generatePixPayload = (key, name, city, amount, description) => {
  const cleanName = name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().slice(0, 25);
  const cleanCity = city.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().slice(0, 15);
  const cleanAmount = amount.toFixed(2);
  const cleanKey = key.replace(/\s/g, '');

  const merchantAccountInfo = formatTag('00', 'br.gov.bcb.pix') + formatTag('01', cleanKey);
  
  let payload = formatTag('00', '01'); 
  payload += formatTag('26', merchantAccountInfo); 
  payload += formatTag('52', '0000'); 
  payload += formatTag('53', '986'); 
  payload += formatTag('54', cleanAmount); 
  payload += formatTag('58', 'BR'); 
  payload += formatTag('59', cleanName); 
  payload += formatTag('60', cleanCity); 
  payload += formatTag('62', formatTag('05', description.slice(0, 25))); 
  payload += '6304'; 
  
  return payload + crc16(payload);
};

// Componente para ícones do PIX
const PixIcon = ({ type }) => {
  const iconProps = { className: "w-4 h-4" };
  switch(type) {
    case 'phone': return <Phone {...iconProps} />;
    case 'cpf': return <Fingerprint {...iconProps} />;
    case 'email': return <Mail {...iconProps} />;
    default: return <Hash {...iconProps} />;
  }
};

export default function App() {
  const [view, setView] = useState('client'); 
  const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
  const [user, setUser] = useState(null);
  const [gifts, setGifts] = useState([]);
  const [contributions, setContributions] = useState([]);
  const [loading, setLoading] = useState(true);
  
  // Estados do Convidado
  const [selectedGift, setSelectedGift] = useState(null);
  const [guestName, setGuestName] = useState('');
  const [quantity, setQuantity] = useState(1);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showPixModal, setShowPixModal] = useState(false);
  const [copySuccess, setCopySuccess] = useState(false);
  const [pixPayload, setPixPayload] = useState('');

  // Estados do Administrador
  const [newItem, setNewItem] = useState({ nome: '', valor: '', img: '', linkPagamento: 'pix', pixKey: '', pixType: 'email' });
  const [editingItem, setEditingItem] = useState(null);
  const [itemToDelete, setItemToDelete] = useState(null);
  const [contributionToDelete, setContributionToDelete] = useState(null);
  const [showDeleteAllConfirm, setShowDeleteAllConfirm] = useState(false);
  const [passInput, setPassInput] = useState('');

  // Inicializar autenticação anónima para acesso ao Firestore
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) { 
        console.error("Erro na autenticação:", error); 
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // Escutar alterações nos documentos do Firestore em tempo real
  useEffect(() => {
    if (!user) return;
    
    const giftsRef = collection(db, 'artifacts', appId, 'public', 'data', 'gifts');
    const unsubGifts = onSnapshot(query(giftsRef), (snapshot) => {
      setGifts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
      setLoading(false);
    }, (error) => console.error("Erro ao carregar presentes:", error));

    const contribRef = collection(db, 'artifacts', appId, 'public', 'data', 'contributions');
    const unsubContribs = onSnapshot(query(contribRef), (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setContributions(data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
    }, (error) => console.error("Erro ao carregar contribuições:", error));

    return () => { unsubGifts(); unsubContribs(); };
  }, [user]);

  // Lógica para confirmar presente e gerar payload PIX
  const handleConfirmGift = async () => {
    if (!guestName.trim() || !user || !selectedGift) return;
    setIsSubmitting(true);
    const totalValue = (selectedGift.valor || 0) * quantity;
    
    try {
      // Guardar intenção no banco de dados
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'contributions'), {
        giftId: selectedGift.id,
        giftName: selectedGift.nome,
        guestName: guestName,
        quantity: quantity,
        unitValue: selectedGift.valor,
        totalValue: totalValue,
        timestamp: new Date().toISOString()
      });

      if (selectedGift.linkPagamento === 'pix') {
        const payload = generatePixPayload(
          selectedGift.pixKey || '',
          'GUI E NURIA',
          'SAO PAULO',
          totalValue,
          'PRESENTE'
        );
        setPixPayload(payload);
        setShowPixModal(true);
      } else {
        window.location.href = selectedGift.linkPagamento;
      }
    } catch (e) { 
      console.error("Erro ao processar contribuição:", e); 
    } finally { 
      setIsSubmitting(false); 
    }
  };

  const handleFinishProcess = () => {
    setShowPixModal(false);
    setSelectedGift(null);
    setGuestName('');
    setQuantity(1);
    setPixPayload('');
    setView('client');
  };

  // Funções de administração do banco de dados
  const addItem = async (e) => {
    e.preventDefault();
    if (!user) return;
    const id = Date.now().toString();
    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gifts', id), {
      ...newItem, id, valor: parseFloat(newItem.valor || 0)
    });
    setNewItem({ nome: '', valor: '', img: '', linkPagamento: 'pix', pixKey: '', pixType: 'email' });
  };

  const handleUpdateItem = async (e) => {
    e.preventDefault();
    if (!user || !editingItem) return;
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gifts', editingItem.id), {
      ...editingItem, valor: parseFloat(editingItem.valor || 0)
    });
    setEditingItem(null);
  };

  const confirmDelete = async () => {
    if (!user || !itemToDelete) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gifts', itemToDelete.id));
    setItemToDelete(null);
  };

  const deleteContribution = async (id) => {
    if (!user) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'contributions', id));
  };

  const deleteAllContributions = async () => {
    if (!user) return;
    const batch = writeBatch(db);
    const snapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'contributions'));
    snapshot.forEach((d) => batch.delete(d.ref));
    await batch.commit();
    setShowDeleteAllConfirm(false);
  };

  const copyToClipboard = (text) => {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    setCopySuccess(true);
    setTimeout(() => setCopySuccess(false), 2000);
    document.body.removeChild(textArea);
  };

  if (loading) return (
    <div className="min-h-screen flex items-center justify-center bg-stone-50">
      <Loader2 className="w-10 h-10 animate-spin text-stone-300" />
    </div>
  );

  // --- VISÃO ADMINISTRADOR ---
  if (view === 'admin') {
    if (!isAdminAuthenticated) {
      return (
        <div className="min-h-screen flex items-center justify-center bg-stone-100 p-6 font-sans">
          <div className="bg-white p-10 rounded-[2.5rem] shadow-xl w-full max-w-md text-center border border-stone-200">
            <Settings className="w-12 h-12 text-stone-200 mx-auto mb-6" />
            <h2 className="text-2xl font-light mb-2">Painel do Casal</h2>
            <p className="text-stone-400 mb-8 text-sm">Digite a senha para gerenciar o site</p>
            <input type="password" value={passInput || ''} onChange={e => setPassInput(e.target.value)} placeholder="Senha de acesso" className="w-full border-b border-stone-200 focus:border-stone-900 outline-none py-4 mb-8 text-center text-2xl tracking-widest transition-all" onKeyPress={e => e.key === 'Enter' && (passInput === ADMIN_PASSWORD ? setIsAdminAuthenticated(true) : alert("Incorreta!"))} />
            <button onClick={() => passInput === ADMIN_PASSWORD ? setIsAdminAuthenticated(true) : alert("Incorreta!")} className="w-full py-5 bg-stone-900 text-white rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-black transition-all shadow-md">Acessar</button>
            <button onClick={() => setView('client')} className="mt-6 text-stone-400 text-xs uppercase tracking-widest hover:text-stone-600">Voltar para o site</button>
          </div>
        </div>
      );
    }
    return (
      <div className="min-h-screen bg-stone-50 font-sans text-stone-800">
        <nav className="bg-white border-b border-stone-100 p-6 sticky top-0 z-10 shadow-sm flex justify-between items-center">
          <div className="flex items-center gap-2">
            <Heart className="w-5 h-5 text-rose-300" />
            <h1 className="font-serif text-2xl tracking-tight text-stone-900">Gestão de Casamento</h1>
          </div>
          <button onClick={() => setView('client')} className="text-xs uppercase tracking-widest bg-stone-100 px-6 py-3 rounded-xl font-bold border border-stone-200 hover:bg-white transition-all">Sair do Painel</button>
        </nav>
        <main className="max-w-7xl mx-auto p-6 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-10">
          <div className="lg:col-span-1 bg-white p-8 rounded-[2rem] shadow-sm border border-stone-100 h-fit">
            <h2 className="font-bold uppercase text-[10px] tracking-[0.2em] text-stone-500 mb-8">Novo Presente</h2>
            <form onSubmit={addItem} className="space-y-5">
              <input placeholder="Nome do Presente" className="w-full p-4 bg-stone-50 rounded-xl outline-none border border-transparent focus:border-stone-100 transition-all" value={newItem.nome || ''} onChange={e => setNewItem({...newItem, nome: e.target.value})} required />
              <input placeholder="Valor (R$)" type="number" step="0.01" className="w-full p-4 bg-stone-50 rounded-xl outline-none border border-transparent focus:border-stone-100 transition-all" value={newItem.valor || ''} onChange={e => setNewItem({...newItem, valor: e.target.value})} required />
              <input placeholder="URL da Imagem" className="w-full p-4 bg-stone-50 rounded-xl outline-none text-xs border border-transparent focus:border-stone-100 transition-all" value={newItem.img || ''} onChange={e => setNewItem({...newItem, img: e.target.value})} />
              <select className="w-full p-4 bg-stone-50 rounded-xl outline-none cursor-pointer" value={newItem.linkPagamento} onChange={e => setNewItem({...newItem, linkPagamento: e.target.value})}>
                <option value="pix">Pagamento via PIX</option>
                <option value="link">Link de Pagamento Externo</option>
              </select>
              {newItem.linkPagamento === 'pix' && (
                <div className="p-4 bg-rose-50/30 rounded-2xl border border-rose-100 space-y-3">
                  <select className="w-full p-3 bg-white rounded-lg outline-none text-sm border border-stone-100" value={newItem.pixType} onChange={e => setNewItem({...newItem, pixType: e.target.value})}>
                    <option value="phone">Celular</option>
                    <option value="cpf">CPF</option>
                    <option value="email">E-mail</option>
                    <option value="random">Chave Aleatória</option>
                  </select>
                  <input placeholder="Chave PIX" className="w-full p-3 bg-white rounded-lg outline-none text-sm border border-stone-100" value={newItem.pixKey || ''} onChange={e => setNewItem({...newItem, pixKey: e.target.value})} />
                </div>
              )}
              <button type="submit" className="w-full py-5 bg-stone-900 text-white rounded-2xl font-bold hover:shadow-lg transition-all active:scale-95">Adicionar à Lista</button>
            </form>
          </div>
          
          <div className="lg:col-span-2 space-y-10">
            <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-stone-100">
              <div className="flex justify-between items-center mb-8">
                <h2 className="font-bold uppercase text-[10px] tracking-[0.2em] text-stone-500">Contribuições Recebidas</h2>
                {contributions.length > 0 && <button onClick={() => setShowDeleteAllConfirm(true)} className="text-[10px] text-red-400 font-bold uppercase hover:text-red-600 transition-colors">Limpar Tudo</button>}
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-left text-sm">
                  <thead className="text-[10px] uppercase text-stone-400 border-b">
                    <tr><th className="pb-4">Convidado</th><th className="pb-4">Presente</th><th className="pb-4">Total</th><th className="pb-4"></th></tr>
                  </thead>
                  <tbody className="divide-y divide-stone-50">
                    {contributions.map(c => (
                      <tr key={c.id} className="hover:bg-stone-50/50 transition-colors">
                        <td className="py-4 font-medium">{c.guestName}</td>
                        <td className="py-4 text-stone-500">{c.giftName} ({c.quantity}x)</td>
                        <td className="py-4 font-bold text-stone-900">R$ {c.totalValue?.toFixed(2)}</td>
                        <td className="py-4 text-right">
                          <button onClick={() => setContributionToDelete(c)} className="p-2 text-stone-200 hover:text-red-400 transition-colors"><Trash2 className="w-4 h-4" /></button>
                        </td>
                      </tr>
                    ))}
                    {contributions.length === 0 && (
                        <tr><td colSpan="4" className="py-12 text-center text-stone-300 italic font-serif">Nenhuma contribuição recebida ainda.</td></tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>

            <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-stone-100">
              <h2 className="font-bold uppercase text-[10px] tracking-[0.2em] text-stone-500 mb-8">Presentes Ativos ({gifts.length})</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {gifts.map(item => (
                  <div key={item.id} className="flex items-center gap-4 p-4 border rounded-2xl bg-stone-50/30 hover:bg-stone-50 transition-all border-stone-50 group">
                    <img src={item.img || 'https://via.placeholder.com/100'} className="w-12 h-12 rounded-xl object-cover shadow-sm" alt="" />
                    <div className="flex-grow min-w-0">
                      <p className="font-medium text-sm truncate text-stone-800">{item.nome}</p>
                      <p className="text-xs text-stone-400">R$ {item.valor?.toFixed(2)}</p>
                    </div>
                    <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                      <button onClick={() => setEditingItem(item)} className="p-2 text-stone-300 hover:text-stone-900 transition-colors"><Pencil className="w-4 h-4" /></button>
                      <button onClick={() => setItemToDelete(item)} className="p-2 text-stone-300 hover:text-red-500 transition-colors"><Trash2 className="w-4 h-4" /></button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </main>

        {/* MODAIS DE ADMIN COM FEEDBACK VISUAL */}
        {contributionToDelete && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-stone-900/40 backdrop-blur-sm">
            <div className="bg-white p-8 rounded-[2rem] shadow-2xl max-w-sm w-full text-center animate-in zoom-in duration-300">
              <AlertTriangle className="w-10 h-10 text-red-500 mx-auto mb-4" />
              <h3 className="text-xl font-bold mb-2">Remover Registro?</h3>
              <p className="text-sm text-stone-500 mb-8">Deseja remover o registro de "{contributionToDelete.guestName}"? Esta ação não pode ser desfeita.</p>
              <div className="flex gap-3">
                <button onClick={() => setContributionToDelete(null)} className="flex-1 py-3 bg-stone-100 rounded-xl font-bold text-stone-600 transition-all">Cancelar</button>
                <button onClick={() => { deleteContribution(contributionToDelete.id); setContributionToDelete(null); }} className="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold shadow-md">Excluir</button>
              </div>
            </div>
          </div>
        )}

        {showDeleteAllConfirm && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-stone-900/40 backdrop-blur-sm">
            <div className="bg-white p-8 rounded-[2rem] shadow-2xl max-w-sm w-full text-center">
              <AlertTriangle className="w-10 h-10 text-red-500 mx-auto mb-4" />
              <h3 className="text-xl font-bold mb-2">Limpar Histórico?</h3>
              <p className="text-sm text-stone-500 mb-8">Isto excluirá permanentemente TODAS as contribuições recebidas.</p>
              <div className="flex gap-3">
                <button onClick={() => setShowDeleteAllConfirm(false)} className="flex-1 py-3 bg-stone-100 rounded-xl font-bold text-stone-600">Cancelar</button>
                <button onClick={deleteAllContributions} className="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold">Sim, Limpar</button>
              </div>
            </div>
          </div>
        )}

        {itemToDelete && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-stone-900/40 backdrop-blur-sm">
            <div className="bg-white p-8 rounded-[2rem] shadow-2xl max-w-sm w-full text-center">
              <AlertTriangle className="w-10 h-10 text-red-500 mx-auto mb-4" />
              <h3 className="text-xl font-bold mb-2">Excluir Presente?</h3>
              <p className="text-sm text-stone-500 mb-8 leading-relaxed">Deseja remover "{itemToDelete.nome}" da lista pública?</p>
              <div className="flex gap-3">
                <button onClick={() => setItemToDelete(null)} className="flex-1 py-3 bg-stone-100 rounded-xl font-bold text-stone-600 transition-all">Não</button>
                <button onClick={confirmDelete} className="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold shadow-md">Sim, Excluir</button>
              </div>
            </div>
          </div>
        )}

        {editingItem && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-stone-900/40 backdrop-blur-sm">
            <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl max-w-md w-full animate-in zoom-in duration-200 max-h-[90vh] overflow-y-auto text-center">
              <div className="flex justify-between items-center mb-8">
                <h3 className="text-2xl font-serif text-stone-900">Editar Item</h3>
                <button onClick={() => setEditingItem(null)} className="p-2 hover:bg-stone-50 rounded-full transition-colors"><X className="w-6 h-6 text-stone-400" /></button>
              </div>
              <form onSubmit={handleUpdateItem} className="space-y-4">
                <div className="text-left space-y-1">
                  <label className="text-[10px] uppercase tracking-widest text-stone-400 ml-1">Nome do Item</label>
                  <input className="w-full p-4 bg-stone-50 rounded-xl outline-none border border-transparent focus:border-stone-200 transition-all" value={editingItem.nome || ''} onChange={e => setEditingItem({...editingItem, nome: e.target.value})} required />
                </div>
                <div className="text-left space-y-1">
                  <label className="text-[10px] uppercase tracking-widest text-stone-400 ml-1">Valor unitário</label>
                  <input type="number" step="0.01" className="w-full p-4 bg-stone-50 rounded-xl outline-none border border-transparent focus:border-stone-200 transition-all" value={editingItem.valor || ''} onChange={e => setEditingItem({...editingItem, valor: e.target.value})} required />
                </div>
                <div className="text-left space-y-1">
                  <label className="text-[10px] uppercase tracking-widest text-stone-400 ml-1">Imagem URL</label>
                  <input className="w-full p-4 bg-stone-50 rounded-xl outline-none text-xs border border-transparent focus:border-stone-200 transition-all" value={editingItem.img || ''} onChange={e => setEditingItem({...editingItem, img: e.target.value})} />
                </div>
                <div className="p-4 bg-stone-50 rounded-2xl space-y-3 border border-stone-100">
                   <select className="w-full p-3 bg-white rounded-lg outline-none text-sm border border-stone-100" value={editingItem.pixType} onChange={e => setEditingItem({...editingItem, pixType: e.target.value})}>
                    <option value="phone">Celular</option>
                    <option value="cpf">CPF</option>
                    <option value="email">E-mail</option>
                    <option value="random">Chave Aleatória</option>
                  </select>
                  <input className="w-full p-3 bg-white rounded-lg outline-none text-sm border border-stone-100" value={editingItem.pixKey || ''} onChange={e => setEditingItem({...editingItem, pixKey: e.target.value})} />
                </div>
                <button type="submit" className="w-full py-4 bg-stone-900 text-white rounded-xl font-bold mt-4 shadow-lg hover:bg-black transition-all">Salvar Alterações</button>
              </form>
            </div>
          </div>
        )}
      </div>
    );
  }

  // --- VISÃO CLIENTE ---
  return (
    <div className="min-h-screen bg-stone-50 text-stone-900 font-serif selection:bg-rose-100">
      <header className="py-28 px-4 text-center bg-white border-b border-stone-100 relative shadow-sm">
        <div className="max-w-4xl mx-auto animate-in fade-in slide-in-from-top duration-1000">
          <Heart className="w-12 h-12 mx-auto mb-8 text-rose-200 fill-rose-50" />
          <h1 className="text-6xl md:text-8xl font-light mb-8 tracking-tighter text-stone-800">Gui & Nuria</h1>
          <div className="w-40 h-px bg-stone-100 mx-auto mb-8"></div>
          <p className="text-stone-400 uppercase tracking-[0.5em] text-[10px] md:text-xs font-sans font-light">Lista de Presentes do Casamento</p>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-6 py-24">
        <section className="text-center mb-24 max-w-3xl mx-auto italic">
          <p className="text-2xl md:text-3xl text-stone-400 leading-relaxed font-light font-serif">"Sua presença é o nosso maior presente. Mas se desejar contribuir para o início da nossa vida a dois, preparamos algumas opções abaixo."</p>
        </section>

        {gifts.length === 0 ? (
          <div className="text-center py-20 text-stone-300 font-serif italic text-xl border-2 border-dashed border-stone-100 rounded-[3rem]">Aguardando a lista de presentes ser atualizada pelo casal...</div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-12 font-sans">
            {gifts.map((item) => (
              <div key={item.id} className="group bg-white rounded-[2.5rem] overflow-hidden shadow-sm hover:shadow-2xl transition-all duration-700 border border-stone-100 flex flex-col transform hover:-translate-y-3">
                <div className="relative h-80 overflow-hidden">
                  <img src={item.img || 'https://images.unsplash.com/photo-1511795409834-ef04bbd61622?q=80&w=800'} alt={item.nome} className="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-110" />
                  <div className="absolute inset-0 bg-stone-900/0 group-hover:bg-stone-900/5 transition-all"></div>
                </div>
                <div className="p-10 flex flex-col flex-grow text-center border-t border-stone-50">
                  <h3 className="text-2xl font-serif font-light mb-4 text-stone-800 tracking-tight leading-tight">{item.nome}</h3>
                  <p className="text-stone-400 text-[10px] mb-10 tracking-[0.2em] uppercase font-bold">COTA SUGERIDA: <span className="text-stone-900 ml-1">R$ {item.valor?.toFixed(2)}</span></p>
                  <button onClick={() => { setSelectedGift(item); setGuestName(''); setQuantity(1); }} className="mt-auto w-full py-5 px-6 bg-stone-900 text-white rounded-2xl text-[10px] tracking-[0.2em] uppercase hover:bg-black transition-all flex items-center justify-center gap-3 active:scale-95 shadow-md"><Gift className="w-4 h-4 opacity-70" /> Presentear</button>
                </div>
              </div>
            ))}
          </div>
        )}
      </main>

      <footer className="py-24 bg-white border-t border-stone-50 text-center font-sans">
        <p className="text-stone-400 text-[10px] tracking-[0.4em] uppercase font-light mb-6 tracking-[0.5em]">Gui & Nuria • 2025</p>
        <button onClick={() => setView('admin')} className="text-stone-200 hover:text-stone-500 transition-all flex items-center gap-2 mx-auto text-[10px] uppercase tracking-widest p-4 rounded-full border border-transparent hover:border-stone-100"><Settings className="w-3 h-3" /> Painel do Casal</button>
      </footer>

      {/* MODAL CLIENTE - RESERVA */}
      {selectedGift && !showPixModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-stone-900/40 backdrop-blur-sm animate-in fade-in duration-300">
          <div className="relative bg-white w-full max-w-md rounded-[3rem] shadow-2xl p-12 text-center font-sans scale-in-center border border-stone-100">
            <h3 className="text-4xl font-serif font-light text-stone-800 mb-2 tracking-tighter">Com Carinho</h3>
            <p className="text-stone-400 text-sm mb-10 font-light italic">Você está presenteando com: <span className="text-stone-900 font-medium">{selectedGift.nome}</span></p>
            <div className="space-y-8 text-left">
              <div className="group">
                <label className="block text-[10px] uppercase tracking-[0.2em] text-stone-400 mb-2 font-bold">Seu Nome ou Família</label>
                <input type="text" autoFocus value={guestName || ''} onChange={e => setGuestName(e.target.value)} placeholder="Como devemos assinar o presente?" className="w-full border-b border-stone-200 focus:border-stone-900 outline-none py-4 text-xl bg-transparent transition-all placeholder:text-stone-200" />
              </div>
              <div className="flex items-center justify-between bg-stone-50 p-6 rounded-3xl border border-stone-100">
                <span className="text-[10px] uppercase tracking-widest text-stone-400 font-bold">Quantidade de Cotas</span>
                <div className="flex items-center gap-6">
                  <button onClick={() => setQuantity(q => Math.max(1, q-1))} className="w-10 h-10 flex items-center justify-center bg-white border border-stone-100 rounded-xl text-stone-500 hover:bg-rose-50 transition-colors shadow-sm"><Minus className="w-4 h-4" /></button>
                  <span className="text-2xl font-light w-4 text-center text-stone-900">{quantity}</span>
                  <button onClick={() => setQuantity(q => q+1)} className="w-10 h-10 flex items-center justify-center bg-white border border-stone-100 rounded-xl text-stone-500 hover:bg-rose-50 transition-colors shadow-sm"><Plus className="w-4 h-4" /></button>
                </div>
              </div>
              <div className="text-center pt-2">
                <p className="text-[10px] uppercase text-stone-400 mb-1 font-bold">Total do Presente</p>
                <p className="text-4xl font-serif italic text-stone-900">R$ {(selectedGift.valor * quantity).toFixed(2)}</p>
              </div>
              <button onClick={handleConfirmGift} disabled={!guestName.trim() || isSubmitting} className="w-full py-6 bg-stone-900 text-white rounded-[2rem] font-bold shadow-xl flex items-center justify-center gap-3 hover:bg-black active:scale-95 transition-all">
                {isSubmitting ? <Loader2 className="animate-spin" /> : "Confirmar e Pagar"}
              </button>
              <button onClick={() => setSelectedGift(null)} className="w-full text-stone-300 text-[10px] uppercase tracking-widest mt-4 hover:text-stone-500 transition-colors font-bold text-center">Voltar</button>
            </div>
          </div>
        </div>
      )}

      {/* MODAL CLIENTE - PAGAMENTO PIX DINÂMICO */}
      {showPixModal && selectedGift && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-stone-900/60 backdrop-blur-xl animate-in fade-in duration-500">
          <div className="relative bg-white w-full max-w-md rounded-[3.5rem] shadow-2xl p-12 text-center font-sans border border-stone-100">
            <h3 className="text-4xl font-serif font-light mb-4 tracking-tighter text-stone-800">Muito Obrigado!</h3>
            <p className="text-stone-500 text-sm mb-10 leading-relaxed font-light">
              <b>{guestName}</b>, aponte a câmera do seu banco para o QR Code abaixo para pagar o presente de <b>R$ {(selectedGift.valor * quantity).toFixed(2)}</b>.
            </p>
            <div className="bg-stone-50 p-8 rounded-[3rem] mb-10 flex flex-col items-center border border-stone-100 shadow-inner">
              <div className="bg-white p-4 rounded-[2rem] shadow-sm mb-4">
                <img 
                  src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(pixPayload)}`} 
                  className="w-56 h-56 object-contain rounded-lg" 
                  alt="QR Code de Pagamento Válido"
                />
              </div>
              <div className="flex items-center gap-2 text-stone-400 text-[10px] uppercase tracking-[0.3em] font-bold">
                <QrCode className="w-3 h-3" />
                PIX COPIA E COLA ABAIXO
              </div>
            </div>
            <div className="bg-stone-50 p-6 rounded-2xl mb-10 relative border text-left border-stone-100 group hover:bg-white transition-all">
              <div className="flex items-center gap-2 mb-2 text-rose-300 font-bold">
                <PixIcon type={selectedGift.pixType} />
                <span className="text-[10px] uppercase tracking-widest">Código Pix</span>
              </div>
              <p className="text-stone-500 pr-12 leading-relaxed font-mono text-[10px] break-all line-clamp-2">{pixPayload}</p>
              <button onClick={() => copyToClipboard(pixPayload)} className="absolute right-3 top-1/2 -translate-y-1/2 p-3 bg-white shadow-sm border border-stone-50 rounded-xl transition-all active:scale-90 hover:bg-stone-50">
                {copySuccess ? <Check className="w-4 h-4 text-emerald-500" /> : <Copy className="w-4 h-4 text-stone-300" />}
              </button>
            </div>
            <button onClick={handleFinishProcess} className="w-full py-6 bg-stone-900 text-white rounded-[2rem] font-bold shadow-lg uppercase tracking-widest text-[10px] active:scale-95 transition-all hover:bg-black">Já realizei o pagamento</button>
          </div>
        </div>
      )}
    </div>
  );
}