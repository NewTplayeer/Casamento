<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Presentes - Gui & Nuria</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .scale-in { animation: scaleIn 0.3s ease-out; }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-stone-50 text-stone-900 selection:bg-rose-100">

    <!-- APP CONTAINER -->
    <div id="app">
        <!-- CABEÇALHO -->
        <header class="py-20 px-4 text-center bg-white border-b border-stone-200 relative shadow-sm">
            <div class="max-w-4xl mx-auto">
                <i data-lucide="heart" class="w-10 h-10 mx-auto mb-6 text-rose-200 fill-rose-50"></i>
                <h1 class="text-5xl md:text-7xl font-serif font-light mb-6 tracking-tighter text-stone-800">Gui & Nuria</h1>
                <div class="w-32 h-px bg-stone-100 mx-auto mb-6"></div>
                <p class="text-stone-400 uppercase tracking-[0.5em] text-[10px] md:text-xs font-light">Lista de Presentes do Casamento</p>
            </div>
        </header>

        <!-- BANNER DE STATUS (Para erros de permissão) -->
        <div id="status-banner" class="hidden max-w-4xl mx-auto mt-8 p-4 rounded-xl text-sm text-center font-sans shadow-md border animate-pulse"></div>

        <!-- CONTEÚDO PRINCIPAL (CLIENTE) -->
        <main id="client-view" class="max-w-7xl mx-auto px-6 py-16 block">
            <section class="text-center mb-16 max-w-3xl mx-auto italic">
                <p class="text-2xl md:text-3xl text-stone-400 leading-relaxed font-light font-serif">
                    "A vossa presença é o nosso maior presente. Mas se desejar contribuir para o início da nossa vida a dois, preparámos algumas opções abaixo."
                </p>
            </section>

            <div id="gifts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
                <div class="col-span-full text-center py-20 text-stone-300 animate-pulse font-serif italic text-xl">A carregar presentes...</div>
            </div>
        </main>

        <!-- VISTA ADMIN -->
        <main id="admin-view" class="max-w-7xl mx-auto p-6 md:p-10 hidden font-sans">
            <div class="flex justify-between items-center mb-10 border-b pb-6">
                <h2 class="font-serif text-3xl text-stone-800 font-bold">Gestão do Casamento</h2>
                <button onclick="switchView('client')" class="text-xs uppercase tracking-widest bg-stone-200 px-6 py-3 rounded-xl font-bold hover:bg-stone-300 transition-all">Sair do Painel</button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 text-left">
                <!-- COLUNA ESQUERDA: GESTÃO DE PRESENTES -->
                <div class="lg:col-span-1 space-y-8">
                    <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-stone-100 h-fit">
                        <h3 class="font-bold uppercase text-[10px] tracking-widest text-stone-500 mb-8 flex items-center gap-2">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> Configurar Presente
                        </h3>
                        <form id="gift-form" class="space-y-5">
                            <input type="hidden" id="edit-id">
                            <div class="space-y-1">
                                <label class="text-[10px] uppercase font-bold text-stone-400 ml-1">Nome do Item</label>
                                <input id="form-nome" placeholder="Ex: Geladeira Frost Free" class="w-full p-4 bg-stone-50 rounded-xl outline-none border border-transparent focus:border-stone-200 transition-all shadow-inner" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label class="text-[10px] uppercase font-bold text-stone-400 ml-1">Valor Unitário</label>
                                    <input id="form-valor" type="number" step="0.01" placeholder="0.00" class="w-full p-4 bg-stone-50 rounded-xl outline-none border border-transparent focus:border-stone-200 transition-all shadow-inner" required>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] uppercase font-bold text-stone-400 ml-1">Qtd Cotas</label>
                                    <input id="form-total-quotas" type="number" placeholder="10" class="w-full p-4 bg-stone-50 rounded-xl outline-none border border-transparent focus:border-stone-200 transition-all shadow-inner" required>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] uppercase font-bold text-stone-400 ml-1">Link da Imagem</label>
                                <input id="form-img" placeholder="https://..." class="w-full p-4 bg-stone-50 rounded-xl outline-none border border-transparent focus:border-stone-200 text-xs transition-all shadow-inner">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] uppercase font-bold text-stone-400 ml-1">Chave PIX</label>
                                <input id="form-pix-key" placeholder="Digite a chave" class="w-full p-4 bg-stone-50 rounded-xl outline-none border border-transparent focus:border-stone-200 transition-all shadow-inner">
                            </div>
                            <button type="submit" id="btn-save" class="w-full py-5 bg-stone-900 text-white rounded-2xl font-bold hover:bg-black transition-all active:scale-95 shadow-lg">Guardar Presente</button>
                            <button type="button" id="btn-cancel-edit" onclick="resetGiftForm()" class="w-full py-2 text-stone-400 text-[10px] uppercase font-bold hidden">Cancelar Edição</button>
                        </form>
                    </div>

                    <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-stone-100">
                        <h3 class="font-bold uppercase text-[10px] tracking-widest text-stone-500 mb-6 flex items-center gap-2">
                            <i data-lucide="package" class="w-4 h-4"></i> Itens na Vitrine
                        </h3>
                        <div id="admin-gifts-list" class="space-y-3"></div>
                    </div>
                </div>

                <!-- COLUNA DIREITA: HISTÓRICO DE RECEBIMENTOS -->
                <div class="lg:col-span-2">
                    <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-stone-100">
                        <div class="flex justify-between items-center mb-8">
                            <h3 class="font-bold uppercase text-[10px] tracking-widest text-stone-500 flex items-center gap-2">
                                <i data-lucide="list" class="w-4 h-4"></i> Contribuições Recebidas
                            </h3>
                            <button onclick="handleClearAllContribs()" class="text-[10px] text-red-400 font-bold uppercase hover:text-red-600 transition-colors">Limpar Tudo</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="text-stone-400 border-b font-sans"><tr class="uppercase text-[10px]">
                                    <th class="pb-4">Convidado</th><th class="pb-4">Presente</th><th class="pb-4 text-center">Qtd</th><th class="pb-4">Total</th><th class="pb-4 text-right">Ação</th>
                                </tr></thead>
                                <tbody id="contributions-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- RODAPÉ -->
        <footer class="py-24 bg-white border-t border-stone-50 text-center">
            <p class="text-stone-400 text-[10px] tracking-[0.5em] uppercase font-light mb-6">Gui & Nuria • 2025</p>
            <button onclick="openLoginModal()" class="text-stone-200 hover:text-stone-500 flex items-center gap-2 mx-auto text-[10px] uppercase tracking-widest p-4 rounded-full border border-transparent hover:border-stone-50 transition-all font-sans">
                <i data-lucide="settings" class="w-3 h-3"></i> Área do Casal
            </button>
        </footer>
    </div>

    <!-- MODAL: LOGIN ADMIN -->
    <div id="modal-login" class="fixed inset-0 z-[100] hidden items-center justify-center p-6 bg-stone-900/40 backdrop-blur-sm">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl max-w-sm w-full text-center scale-in border border-stone-100">
            <i data-lucide="lock" class="w-10 h-10 text-stone-200 mx-auto mb-6"></i>
            <h3 class="text-2xl font-serif font-bold mb-2">Acesso Restrito</h3>
            <input type="password" id="admin-pass" placeholder="Senha" class="w-full border-b border-stone-200 outline-none py-4 text-center text-2xl tracking-widest mb-10 bg-transparent transition-all">
            <button onclick="handleLogin()" class="w-full py-5 bg-stone-900 text-white rounded-2xl font-bold shadow-lg">Login</button>
            <button onclick="closeModal('modal-login')" class="mt-4 text-stone-300 text-[10px] font-bold uppercase tracking-widest">Cancelar</button>
        </div>
    </div>

    <!-- MODAL: SELEÇÃO DE PRESENTE -->
    <div id="modal-gift" class="fixed inset-0 z-50 hidden items-center justify-center p-6 bg-stone-900/40 backdrop-blur-sm font-sans">
        <div class="relative bg-white w-full max-w-md rounded-[3rem] p-12 text-center scale-in shadow-2xl border border-stone-100">
            <h3 class="text-4xl font-serif font-light text-stone-800 mb-2 tracking-tighter leading-tight">Com Carinho</h3>
            <p id="selected-gift-name" class="text-stone-400 text-sm mb-10 italic"></p>
            <div class="space-y-6 text-left">
                <div>
                    <label class="block text-[10px] uppercase tracking-widest text-stone-400 mb-2 font-bold">O Teu Nome ou Família</label>
                    <input type="text" id="guest-name" placeholder="Como devemos assinar?" class="w-full border-b border-stone-200 focus:border-stone-900 outline-none py-4 text-xl bg-transparent transition-all placeholder:text-stone-200">
                </div>
                <div class="flex items-center justify-between bg-stone-50 p-6 rounded-3xl border border-stone-100">
                    <span class="text-[10px] uppercase tracking-widest text-stone-400 font-bold">Quantidade</span>
                    <div class="flex items-center gap-6">
                        <button onclick="updateQty(-1)" class="w-10 h-10 flex items-center justify-center bg-white border border-stone-100 rounded-xl text-stone-400 hover:bg-rose-50 transition-colors shadow-sm font-bold">-</button>
                        <span id="gift-qty" class="text-2xl font-bold text-stone-800">1</span>
                        <button onclick="updateQty(1)" class="w-10 h-10 flex items-center justify-center bg-white border border-stone-100 rounded-xl text-stone-400 hover:bg-rose-50 transition-colors shadow-sm font-bold">+</button>
                    </div>
                </div>
                <div class="text-center pt-2 border-t border-stone-50">
                    <p class="text-[10px] uppercase text-stone-400 mb-1 font-bold tracking-widest">Valor Total</p>
                    <p id="total-value-display" class="text-4xl font-serif italic text-stone-900"></p>
                </div>
                <button id="btn-confirm-gift" onclick="handleConfirmContribution()" class="w-full py-6 bg-stone-900 text-white rounded-[2rem] font-bold shadow-xl active:scale-95 transition-all">Confirmar e Pagar</button>
                <button onclick="closeModal('modal-gift')" class="w-full text-stone-300 text-[10px] uppercase font-bold mt-4 text-center">Voltar atrás</button>
            </div>
        </div>
    </div>

    <!-- MODAL: PIX -->
    <div id="modal-pix" class="fixed inset-0 z-[60] hidden items-center justify-center p-6 bg-stone-900/60 backdrop-blur-xl font-sans">
        <div class="bg-white w-full max-w-md rounded-[3.5rem] p-12 text-center scale-in border border-stone-100 shadow-2xl">
            <h3 class="text-3xl font-serif font-bold mb-4">Muito Obrigado!</h3>
            <p id="pix-instruction" class="text-stone-500 text-sm mb-10 leading-relaxed"></p>
            <div class="bg-stone-50 p-8 rounded-[3rem] mb-6 flex flex-col items-center border border-stone-100">
                <img id="pix-qr" src="" class="w-48 h-48 mb-4 rounded-lg shadow-sm">
                <span class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">QR Code Válido</span>
            </div>
            <div class="bg-stone-50 p-5 rounded-2xl mb-8 relative text-left border border-stone-100 group transition-all hover:bg-white">
                <span class="text-[8px] uppercase font-bold text-rose-300 block mb-1">Pix Copia e Cola</span>
                <p id="pix-payload-text" class="text-stone-500 text-[9px] break-all line-clamp-2 pr-12 font-mono leading-tight"></p>
                <button onclick="handleCopyPix()" class="absolute right-3 top-1/2 -translate-y-1/2 p-3 bg-white rounded-lg shadow-sm active:scale-90"><i id="copy-icon" data-lucide="copy" class="w-4 h-4 text-stone-300 transition-all"></i></button>
            </div>
            <button onclick="window.location.reload()" class="w-full py-6 bg-stone-900 text-white rounded-[2rem] font-bold shadow-lg hover:bg-black transition-all">Já realizei o pagamento</button>
        </div>
    </div>

    <!-- MODAL: CONFIRMAÇÃO -->
    <div id="modal-confirm" class="fixed inset-0 z-[110] hidden items-center justify-center p-6 bg-stone-900/40 backdrop-blur-sm font-sans">
        <div class="bg-white p-8 rounded-[2rem] shadow-2xl max-w-sm w-full text-center scale-in border border-stone-100">
            <i data-lucide="alert-triangle" class="w-10 h-10 text-rose-400 mx-auto mb-4"></i>
            <h3 id="confirm-title" class="text-xl font-bold mb-2 text-stone-800 leading-tight">Confirmar Acção?</h3>
            <p id="confirm-msg" class="text-sm text-stone-500 mb-8 leading-relaxed"></p>
            <div class="flex gap-3">
                <button onclick="closeModal('modal-confirm')" class="flex-1 py-3 bg-stone-100 rounded-xl font-bold text-stone-600 transition-all hover:bg-stone-200">Cancelar</button>
                <button id="btn-confirm-action" class="flex-1 py-3 bg-rose-500 text-white rounded-xl font-bold shadow-md active:scale-95 transition-all hover:bg-rose-600">Sim, Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setDoc, doc, deleteDoc, updateDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCVjoXpO5PwW3-7B8KBs4jzKQcVWVCzi_s",
            authDomain: "casamento-fb87b.firebaseapp.com",
            projectId: "casamento-fb87b",
            storageBucket: "casamento-fb87b.firebasestorage.app",
            messagingSenderId: "727131908134",
            appId: "1:727131908134:web:e1df1695894c2220171ee7",
            measurementId: "G-QFL6YHZF0X"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // REGRA 1 DO CANVAS: Estrutura obrigatória /artifacts/{appId}/public/data/
        const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'casamento-fb87b';
        const GIFTS_COL_REF = collection(db, 'artifacts', currentAppId, 'public', 'data', 'gifts');
        const CONTRIBS_COL_REF = collection(db, 'artifacts', currentAppId, 'public', 'data', 'contributions');

        // ESTADO GLOBAL
        const ADMIN_PASSWORD = "123"; 
        let gifts = [];
        let contributions = [];
        let selectedGift = null;
        let giftRemaining = 0;
        let qty = 1;
        let user = null;

        // --- UTILITÁRIOS PIX ---
        const crc16 = (data) => {
            let crc = 0xFFFF;
            for (let i = 0; i < data.length; i++) {
                crc ^= data.charCodeAt(i) << 8;
                for (let j = 0; j < 8; j++) {
                    if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021;
                    else crc <<= 1;
                }
            }
            return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        };
        const formatTag = (id, value) => `${id}${value.length.toString().padStart(2, '0')}${value}`;
        const generatePixPayload = (key, name, city, amount) => {
            const cleanKey = key.replace(/\s/g, '');
            const merchantInfo = formatTag('00', 'br.gov.bcb.pix') + formatTag('01', cleanKey);
            let p = formatTag('00', '01') + formatTag('26', merchantInfo) + formatTag('52', '0000') + formatTag('53', '986') + 
                    formatTag('54', amount.toFixed(2)) + formatTag('58', 'BR') + formatTag('59', name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().slice(0, 25)) + 
                    formatTag('60', city.toUpperCase().slice(0, 15)) + formatTag('62', formatTag('05', 'Casamento')) + '6304';
            return p + crc16(p);
        };

        // --- INICIALIZAÇÃO (REGRA 3: Auth First) ---
        async function startApp() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token).catch(async (err) => {
                        console.warn("Custom token falhou, a tentar anónimo:", err.code);
                        return await signInAnonymously(auth);
                    });
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) { 
                console.error("Erro Crítico Auth:", err); 
                showBanner("Erro de autenticação. Ative o Início de sessão anónimo no Console.", "bg-red-500 text-white border-red-700");
            }

            onAuthStateChanged(auth, (u) => { 
                user = u; 
                if (user) {
                    initData();
                }
            });
        }

        function initData() {
            if (!user) return;

            // REGRA 1: Uso rigoroso das referências com appId do ambiente
            onSnapshot(GIFTS_COL_REF, (snap) => {
                gifts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderGifts();
                renderAdminData();
            }, (err) => {
                console.error("Erro snapshot presentes:", err);
                if (err.code === 'permission-denied') {
                    showBanner(`Erro de Permissão: Verifique se as Rules do Firebase permitem acesso a /artifacts/${currentAppId}/...`, "bg-amber-500 text-white border-amber-700");
                }
            });

            onSnapshot(CONTRIBS_COL_REF, (snap) => {
                contributions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderGifts(); 
                renderAdminData();
            }, (err) => console.error("Erro snapshot contribuições:", err));
        }

        function showBanner(msg, classes) {
            const banner = document.getElementById('status-banner');
            banner.innerText = msg;
            banner.className = `max-w-4xl mx-auto mt-8 p-4 rounded-xl text-sm text-center font-sans shadow-lg block border-2 ${classes}`;
        }

        // --- RENDERIZAÇÃO ---
        window.renderGifts = () => {
            const grid = document.getElementById('gifts-grid');
            if (!grid) return;
            if (gifts.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-20 text-stone-300 font-serif italic text-xl border-2 border-dashed border-stone-100 rounded-[3rem]">A carregar presentes...</div>`;
                return;
            }

            grid.innerHTML = gifts.map(item => {
                const used = contributions.filter(c => c.giftId === item.id).reduce((s, c) => s + (parseInt(c.quantity) || 0), 0);
                const rem = Math.max(0, (parseInt(item.totalQuotas) || 1) - used);
                const isSoldOut = rem <= 0;

                return `
                <div class="bg-white rounded-[2.5rem] overflow-hidden shadow-sm hover:shadow-xl transition-all border border-stone-100 flex flex-col transform ${isSoldOut ? 'opacity-70 grayscale-[0.5]' : 'hover:-translate-y-3'}">
                    <div class="relative h-72 overflow-hidden">
                        <img src="${item.img || 'https://images.unsplash.com/photo-1511795409834-ef04bbd61622?w=500'}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                        ${isSoldOut ? '<div class="absolute inset-0 bg-stone-900/30 flex items-center justify-center font-serif text-white text-2xl tracking-widest uppercase">Esgotado</div>' : ''}
                    </div>
                    <div class="p-8 text-center flex-grow flex flex-col font-sans">
                        <h3 class="text-xl font-serif mb-2 text-stone-800 leading-tight">${item.nome}</h3>
                        <p class="text-stone-400 text-[10px] mb-4 tracking-widest uppercase font-bold">COTA: R$ ${parseFloat(item.valor || 0).toFixed(2)}</p>
                        <p class="text-[9px] uppercase font-bold mb-6 tracking-widest ${rem > 0 ? 'text-emerald-600' : 'text-rose-400'}">${rem > 0 ? rem + ' disponíveis' : 'Reservado'}</p>
                        <button onclick="openGiftModal('${item.id}', ${rem})" ${isSoldOut ? 'disabled' : ''} class="w-full py-4 bg-stone-900 text-white rounded-2xl text-[10px] uppercase tracking-widest transition-all font-bold ${isSoldOut ? 'bg-stone-200 text-stone-400' : 'hover:bg-black shadow-md'}">Presentear</button>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        };

        window.renderAdminData = () => {
            const list = document.getElementById('contributions-list');
            if (list) {
                const sortedContribs = [...contributions].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                list.innerHTML = sortedContribs.map(c => `
                    <tr class="border-b border-stone-50 font-sans text-xs">
                        <td class="py-5 font-medium text-stone-800">${c.guestName}</td>
                        <td class="py-5 text-stone-500">${c.giftName}</td>
                        <td class="py-5 text-center font-bold text-stone-400">${c.quantity}x</td>
                        <td class="py-5 font-bold text-stone-900 text-right">R$ ${parseFloat(c.totalValue || 0).toFixed(2)}</td>
                        <td class="py-5 text-right">
                            <button onclick="handleDeleteContrib('${c.id}')" class="p-2 text-stone-200 hover:text-red-400 transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>`).join('');
            }
            
            const giftsList = document.getElementById('admin-gifts-list');
            if (giftsList) {
                giftsList.innerHTML = gifts.map(item => `
                    <div class="flex items-center gap-4 p-4 border rounded-2xl bg-stone-50/30 group hover:bg-white transition-all border-stone-100 font-sans">
                        <div class="flex-grow min-w-0">
                            <p class="font-bold text-xs truncate text-stone-800">${item.nome}</p>
                            <p class="text-[9px] text-stone-400 uppercase tracking-widest font-bold">R$ ${parseFloat(item.valor || 0).toFixed(2)} | Qtd: ${item.totalQuotas}</p>
                        </div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-all">
                            <button onclick="editItem('${item.id}')" class="p-2 text-stone-400 hover:text-stone-900 transition-colors" title="Editar"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button onclick="handleDeleteItem('${item.id}')" class="p-2 text-stone-400 hover:text-red-500 transition-colors" title="Excluir"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`).join('');
            }
            lucide.createIcons();
        };

        // --- ACTIONS Firestore ---
        document.getElementById('gift-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save');
            if (!user) return;
            btn.disabled = true;
            btn.innerText = "A guardar...";

            const id = document.getElementById('edit-id').value || "gift_" + Date.now();
            const data = {
                nome: document.getElementById('form-nome').value,
                valor: parseFloat(document.getElementById('form-valor').value),
                totalQuotas: parseInt(document.getElementById('form-total-quotas').value),
                img: document.getElementById('form-img').value,
                pixKey: document.getElementById('form-pix-key').value,
                timestamp: new Date().toISOString()
            };

            try {
                // REGRA 1: Caminho RIGOROSO
                const giftDoc = doc(db, 'artifacts', currentAppId, 'public', 'data', 'gifts', id);
                await setDoc(giftDoc, data);
                resetGiftForm();
                btn.innerText = "Guardar Presente";
                btn.disabled = false;
            } catch(err) {
                console.error("Erro ao gravar:", err);
                showBanner("Erro de permissão no Firestore ao gravar.", "bg-red-500 text-white border-red-700");
                btn.disabled = false;
                btn.innerText = "Guardar Presente";
            }
        };

        // CORREÇÃO DO BOTÃO DE EDITAR
        window.editItem = (id) => {
            const item = gifts.find(g => g.id === id);
            if (!item) return;
            
            document.getElementById('edit-id').value = id;
            document.getElementById('form-nome').value = item.nome;
            document.getElementById('form-valor').value = item.valor;
            document.getElementById('form-total-quotas').value = item.totalQuotas || 1;
            document.getElementById('form-img').value = item.img || "";
            document.getElementById('form-pix-key').value = item.pixKey || "";
            
            document.getElementById('btn-save').innerText = "Atualizar Item";
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.resetGiftForm = () => {
            document.getElementById('gift-form').reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('btn-save').innerText = "Guardar Presente";
            document.getElementById('btn-cancel-edit').classList.add('hidden');
        };

        window.handleDeleteItem = (id) => {
            showConfirm("Excluir Item?", "Deseja remover este presente da vitrine?", async () => {
                try {
                    const itemDoc = doc(db, 'artifacts', currentAppId, 'public', 'data', 'gifts', id);
                    await deleteDoc(itemDoc);
                    closeModal('modal-confirm');
                } catch(e) { console.error(e); }
            });
        };

        window.handleDeleteContrib = (id) => {
            showConfirm("Remover Registo?", "Deseja apagar este registo do histórico?", async () => {
                try {
                    const contribDoc = doc(db, 'artifacts', currentAppId, 'public', 'data', 'contributions', id);
                    await deleteDoc(contribDoc);
                    closeModal('modal-confirm');
                } catch(e) { console.error(e); }
            });
        };

        window.handleClearAllContribs = () => {
            showConfirm("Limpar Tudo?", "Isto apagará TODAS as contribuições!", async () => {
                try {
                    const batch = writeBatch(db);
                    const snapshot = await getDocs(CONTRIBS_COL_REF);
                    snapshot.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                    closeModal('modal-confirm');
                } catch(e) { console.error(e); }
            });
        };

        // --- INTERAÇÕES CLIENTE ---
        window.openGiftModal = (id, rem) => {
            selectedGift = gifts.find(g => g.id === id);
            qty = 1;
            document.getElementById('guest-name').value = "";
            document.getElementById('selected-gift-name').innerText = `Estás a escolher: ${selectedGift.nome}`;
            window.maxQty = rem;
            updateModalUI();
            document.getElementById('modal-gift').classList.remove('hidden');
            document.getElementById('modal-gift').classList.add('flex');
            lucide.createIcons();
        };

        window.updateQty = (v) => { 
            const n = qty + v; 
            if(n >= 1 && n <= window.maxQty) { qty = n; updateModalUI(); }
        };

        function updateModalUI() {
            document.getElementById('gift-qty').innerText = qty;
            document.getElementById('total-value-display').innerText = `R$ ${(selectedGift.valor * qty).toFixed(2)}`;
        }

        window.handleConfirmContribution = async () => {
            const name = document.getElementById('guest-name').value.trim();
            if(!name) return showBanner("Por favor, assine o presente.", "bg-amber-100 text-amber-700");
            
            const btn = document.getElementById('btn-confirm-gift');
            btn.disabled = true;
            btn.innerText = "A processar...";

            const total = selectedGift.valor * qty;
            try {
                await addDoc(CONTRIBS_COL_REF, {
                    giftId: selectedGift.id, giftName: selectedGift.nome, guestName: name, quantity: qty, totalValue: total, timestamp: new Date().toISOString()
                });

                if(selectedGift.pixKey) {
                    const payload = generatePixPayload(selectedGift.pixKey, 'GUI E NURIA', 'SAO PAULO', total);
                    document.getElementById('pix-payload-text').innerText = payload;
                    document.getElementById('pix-qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(payload)}`;
                    document.getElementById('pix-instruction').innerHTML = `<b>${name}</b>, utilize o telemóvel para ler o QR Code e pagar o presente de <b>R$ ${total.toFixed(2)}</b>.`;
                    closeModal('modal-gift');
                    document.getElementById('modal-pix').classList.remove('hidden');
                    document.getElementById('modal-pix').classList.add('flex');
                    lucide.createIcons();
                } else { window.location.reload(); }
            } catch(e) { 
                console.error(e); 
                showBanner("Erro ao confirmar reserva no banco.", "bg-red-100 text-red-700");
            } finally { 
                btn.disabled = false; 
                btn.innerText = "Confirmar e Pagar"; 
            }
        };

        // --- GESTÃO UI ---
        window.openLoginModal = () => {
            document.getElementById('modal-login').classList.remove('hidden');
            document.getElementById('modal-login').classList.add('flex');
        };

        window.handleLogin = () => {
            if(document.getElementById('admin-pass').value === ADMIN_PASSWORD) {
                switchView('admin');
                closeModal('modal-login');
                document.getElementById('admin-pass').value = "";
            } else { showBanner("Senha incorreta!", "bg-red-500 text-white"); }
        };

        window.switchView = (v) => {
            document.getElementById('client-view').style.display = v === 'client' ? 'block' : 'none';
            document.getElementById('admin-view').style.display = v === 'admin' ? 'block' : 'none';
        };

        window.closeModal = (id) => { 
            document.getElementById(id).classList.add('hidden'); 
            document.getElementById(id).classList.remove('flex'); 
        };

        window.handleCopyPix = () => {
            const text = document.getElementById('pix-payload-text').innerText;
            const temp = document.createElement("textarea");
            temp.value = text;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            const icon = document.getElementById('copy-icon');
            icon.setAttribute('data-lucide', 'check');
            icon.classList.add('text-emerald-500');
            lucide.createIcons();
            setTimeout(() => { icon.setAttribute('data-lucide', 'copy'); icon.classList.remove('text-emerald-500'); lucide.createIcons(); }, 2000);
        };

        window.showConfirm = (title, msg, action) => {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerText = msg;
            document.getElementById('modal-confirm').classList.remove('hidden');
            document.getElementById('modal-confirm').classList.add('flex');
            document.getElementById('btn-confirm-action').onclick = action;
        };

        startApp();
    </script>
</body>
</html>